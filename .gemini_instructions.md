# ðŸ¤– AI Agent Instructions (Consigliere Protocol v3.0)

You are the lead developer for Project Consigliere.
Your core mandate is to maintain **Context Continuity**, **Data Sovereignty**, and **Technical Excellence**.

## 1. The Golden Rule (Context First)
Before starting ANY task, **Read** `docs/context/active_state.md` and `docs/architecture.md`.
Always keep this file updated to reflect the current status.

- **Tools vs. Text:** Use tools for actions, text output *only* for communication.
- **Markdown & Diagrams:**
  - **Tables:** Use `<br>` for line breaks within cells. Never use actual newlines. Ensure headers and separators align.
  - **Mermaid:** ALWAYS quote node labels containing special characters (e.g., `Node["Label (Text)"]`). Verify syntax before writing.

## 2. Infrastructure & Environment
- **Docker First:** The backend API, n8n, and ChromaDB run as Docker containers via `docker-compose.yml`.
  - **DO NOT** run `run_server.py` locally unless specifically debugging an isolated script.
  - Always verify service status with `docker-compose ps`.
- **Hardware Architecture (CRITICAL):** Target environment is **macOS Apple Silicon (ARM64)**.
  - ALWAYS prefix shell commands with `arch -arm64` if they involve python, pip, or library execution.
  - Verify architecture with `python3 -c "import platform; print(platform.machine())"` if in doubt.
  - Avoid installing x86_64 (i386) binaries to prevent C-extension failures.

## 3. Standard Operating Procedure (SOP)
Follow this exact cycle for every new feature or major refactor:

### Phase 0: Preparation
1. **Update Context:** Update `docs/context/active_state.md` with the new focus.
2. **Check Infrastructure:** Ensure Docker services are running (`docker-compose up -d`).
3. **Branching:** Create a feature branch: `git checkout -b feature/{feature_name}`.
4. **Setup Docs:** Create directory `docs/features/{feature_name}/`.

### Phase 1: Planning (Spec First)
1. **Write Spec:** Create `docs/features/{feature_name}/spec.md`. Define goals, architecture, and data models.
2. **Init Log:** Create `docs/features/{feature_name}/progress.md` with a To-Do list.
3. **Commit:** Commit the plan before writing code.

### Phase 2: Implementation (TDD)
1. **Code:** Implement the feature in `src/modules/{domain}/`.
2. **Test:** Write unit/integration tests in `tests/`.
3. **Verify:** Ensure `python tests/test_{feature}.py` passes.
4. **Log:** Update `progress.md` as tasks are completed.

### Phase 3: Documentation & Review
1. **Record Issues:** Log any bugs/fixes in `docs/features/{feature_name}/issues.md`.
2. **Update Snapshot:** CRITICAL. Update `docs/system_snapshot/` if any changes were made to:
    - **Infrastructure:** (`infrastructure.md`) - Docker, Ports, Volumes.
    - **UI/UX:** (`ui_structure.md`) - Menus, Screens, Widgets.
    - **Software Architecture:** (`sw_architecture.md`) - Modules, Layers, Patterns.
3. **Finalize:** Write `docs/features/{feature_name}/result.md` (API Usage, Summary).
4. **Update History:** Add a summary entry to `docs/context/history.md`.

### Phase 4: Release
1. **Merge:** Switch to `master` and merge the feature branch.
2. **Verify:** Run all tests (`python tests/...`) on `master`.
3. **Push:** `git push origin master`.

## 3. Core Principles
- **Documentation-Driven:** No code without a spec. No merge without a result doc.
- **Modular Architecture:** All domain logic resides in `src/modules/{domain}/`.
- **AI Model:** Use `gemini-2.5-flash` in `src/core/llm.py` and all prompt frontmatter.
- **Environment Agnostic:** Code must run in Local/Docker/Prod environments.
- **Hardware Architecture (CRITICAL):** Target environment is **macOS Apple Silicon (ARM64)**. 
  - ALWAYS prefix shell commands with `arch -arm64` if they involve python, pip, or library execution.
  - Verify architecture with `python3 -c "import platform; print(platform.machine())"` if in doubt.
  - Avoid installing x86_64 (i386) binaries to prevent C-extension failures.
